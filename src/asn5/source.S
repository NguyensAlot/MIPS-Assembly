//Anthony Nguyen
//CST250 - Lab 5

#include <xc.h>

#define count_0     16(fp)
#define count_1     20(fp)
#define count_2     24(fp)
#define count_3     28(fp)
#define count_4     32(fp)
#define count_5     36(fp)
#define count_6     40(fp)
#define count_7     44(fp)
#define count_8     48(fp)
#define count_9     52(fp)
#define count_total 56(fp)

.global main

.data
byteArray:      .space 48
countTotal:     .space 8

.text
.set noreorder

.ent main
main:
la      t0, string
lb      t1, 0(t0)
move    a0, t0
move    a1, t1

addiu sp, sp, -24
sw      ra, 20(sp)
sw      fp, 16(sp)
sb      a0, 0(sp)
sb      a1, 4(sp)
jal     is_a_digit
nop

// configure UART TX
la      t9, U1MODESET
li      t0, 0x8000
sw      t0, 0(t9)
la      t9, U1STASET
li      t0, 0x1400
sw      t0, 0(t9)



la      s0, stringLiteral         //load address of string literals
la      s1, newLine
la      s2, count_0
addiu   t3, s2, 40
//separate count outputs =======================
outputLoop:
//output string literals
move    a0, s0
jal     output_string
nop
//output numbers counted
lw      t1, 0(s2)
move    a0, t1
jal     b_to_a
nop

la      s3, byteArray
innerLoop:
move    a0, s3
jal     output_string
nop
addiu   s3, s3, 4
addiu   v0, v0, -1
bnez    v0, innerLoop
nop
//output new line
move    a0, s1
jal     output_string
nop
addiu   s0, s0, 15
addiu   s2, s2, 4

//loop until count 9 is displayed
blt     s2, t3, outputLoop
nop

//total count output ===========================
//output new line
move    a0, s1
jal     output_string
nop
//output string total
la      t1, stringTotal
move    a0, t1
jal     output_string
nop
//sum of counts and output it
la      t2, countTotal
move    a0, t2
jal     sumCount
nop
move    a0, v0
jal     b_to_a
nop

la      s3, byteArray
innerLoop2:
move    a0, s3
jal     output_string
nop
addiu   s3, s3, 4
addiu   v0, v0, -1
bnez    v0, innerLoop2
nop

//output new line
move    a0, s1
jal     output_string
nop
//output new line
move    a0, s1
jal     output_string
nop

endless:
j       endless
nop
.end main

//SUB-ROUTINES
//=================================
//Subroutine: is_a_digit
//Description:
//      reads string and counts
//      the number of appearances for
//      each number.
//=================================
.ent is_a_digit
is_a_digit:
addiu   sp, sp, -64
sw      ra, 60(sp)
sw      fp, 56(sp)
move    fp, sp

loop1:
//check for number
beq     a1, 0x0, leave
nop
blt     a1, 0x30, loop2
nop
bgt     a1, 0x39, loop2

addiu   t9, a1, -0x30
mul     t9, t9, 4
addiu   t9, t9, 16

addu    t1, fp, t9      //set t1 equal to 'fp address' + 't9 address'
lw      t0, 0(t1)
addiu   t0, t0, 1
sw      t0, 0(t1)       //store count into count_"#"

loop2:
//get next element in array
addiu   a0, a0, 1
lb      a1, 0(a0)
j       loop1
nop
leave:
jr      ra
nop
.end is_a_digit

//=================================
//Subroutine: b_to_a
//Description:
//      converts binary valued
//      characters to ascii and stores
//      it into a byte array
//=================================
.ent b_to_a
b_to_a:
addiu   sp, sp, -8
sw      ra, 4(sp)
sw      fp, 0(sp)
move    fp, sp
la      t9, byteArray
li      t8, 0

convert:
divu    a0, 10
mfhi    t0
addiu   t0, t0, 0x30
addiu   fp, fp, -4
sw      t0, 0(fp)
mflo    t1
addiu   t8, t8, 1
bnez    t1, convert      //keep dividing if quotient is non-zero
nop

move    v0, t8
popAndStore:
//store values from stack frame onto byteArray
lb      t0, 0(fp)
addiu   fp, fp, 4
beqz    t8, leave2
nop
sb      t0, 0(t9)
addiu   t9, t9, 4
addiu   t8, t8, -1
j       popAndStore
nop

leave2:
lw      ra, 4(sp)
lw      fp, 0(sp)
move    sp, fp
addiu   sp, sp, 8
j       ra
nop
.end b_to_a

//=================================
//Subroutine: sumCount
//Description:
//      adds up all the counts in the
//      stack frame and returns the
//      value
//=================================
.ent sumCount
sumCount:
la      t0, count_0
addiu   t2, t0, 40
move    a0, zero
loopCount:
lw      t1, 0(t0)
addu    a0, a0, t1
addiu   t0, t0, 4
blt     t0, t2, loopCount
nop
move    v0, a0
j       ra
nop
.end sumCount

//=================================
//Subroutine: output_string
//Description:
//      enables simulator to
//      display characters to the
//      "UART 1 Output"
//=================================
.ent output_string
output_string:
get_byte:
lb      t0, 0(a0)
beq     t0, zero, done
nop
send:
// send TX data
la      t9, U1TXREG
sw      t0, 0(t9)
la      t9, U1STA
wait_tx:
lw      t1, 0(t9)
andi    t1, t1, 0x100
beq     t1, zero, wait_tx
nop
next:
addu    a0, a0, 1
j       get_byte
nop
done:
j       ra
nop
.end output_string


//.macro instrName param1, param2
//.endm


newLine:        .asciiz "\n"
stringLiteral:  .asciiz "Number of 0s: "
                .asciiz "Number of 1s: "
                .asciiz "Number of 2s: "
                .asciiz "Number of 3s: "
                .asciiz "Number of 4s: "
                .asciiz "Number of 5s: "
                .asciiz "Number of 6s: "
                .asciiz "Number of 7s: "
                .asciiz "Number of 8s: "
                .asciiz "Number of 9s: "
stringTotal:    .asciiz "Total number of digits: "


string:
.ascii "this is the start01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456middle789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012!@#$%^&345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "01234567890123456789012345678901234567890123456789"
.ascii "012345678901234567890123456789012345678901234567899"
.asciiz "this is the end"
